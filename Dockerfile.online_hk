## Multi-stage build for mdcp_server_operator - çº¿ä¸Šç¯å¢ƒ

## ===================== Stage 1: Build =====================
FROM golang:1.24.4 AS builder

WORKDIR /app

# é¢„æ‹·è´ go.mod/go.sumï¼ˆæ„å»ºä¸Šä¸‹æ–‡éœ€ä¸ºå·¥ä½œåŒºæ ¹ç›®å½•ï¼‰
COPY mdcp_server_operator/go.mod mdcp_server_operator/go.sum ./

# æ¸…ç†ä»£ç†é…ç½®ï¼Œè®¾ç½®å›½å†…é•œåƒåŠ é€Ÿ
ENV http_proxy= https_proxy= HTTP_PROXY= HTTPS_PROXY= ALL_PROXY= NO_PROXY= no_proxy= \
    GIT_PROXY_COMMAND= GIT_SSH_COMMAND= GIT_SSL_NO_VERIFY=false \
    GOPROXY=https://goproxy.cn,direct GOSUMDB=sum.golang.org \
    GOPATH=/go GOMODCACHE=/go/pkg/mod

RUN git config --system --unset-all http.proxy || true \
 && git config --system --unset-all https.proxy || true \
 && git config --global --unset-all http.proxy || true \
 && git config --global --unset-all https.proxy || true \
 && git config --global http.proxy "" \
 && git config --global https.proxy "" \
 && go env -w GOPROXY=https://goproxy.cn,direct GOSUMDB=sum.golang.org GOPATH=/go GOMODCACHE=/go/pkg/mod \
 && true

# æ‹·è´æœ¬åœ°ä¾èµ–
COPY mdcp_common /mdcp_common
COPY mdcp_proto /mdcp_proto

# å¤åˆ¶ mdcp_server_operator æºç 
COPY mdcp_server_operator/ /app/

# ä¸‹è½½ä¾èµ–ï¼ˆä¼šä½¿ç”¨ go.mod ä¸­çš„ replace æŒ‡å‘æœ¬åœ°è·¯å¾„ï¼‰
RUN go mod download

# ç¼–è¯‘ï¼šæ ¹æ®æ„å»ºå¹³å°è‡ªåŠ¨é€‰æ‹©æ¶æ„
ARG TARGETARCH
RUN echo "ğŸ”¨ ç¼–è¯‘ç›®æ ‡æ¶æ„: ${TARGETARCH:-amd64}" \
 && CGO_ENABLED=0 GOOS=linux GOARCH=${TARGETARCH:-amd64} \
    go build -trimpath -ldflags "-s -w" \
    -o /app/bin/server ./cmd/server

## ===================== Stage 2: Runtime =====================
FROM debian:bookworm-slim

WORKDIR /app

ENV http_proxy= https_proxy= HTTP_PROXY= HTTPS_PROXY= ALL_PROXY= \
    TZ=Asia/Shanghai

RUN apt-get update && apt-get install -y --no-install-recommends \
    tzdata \
    nftables \
    util-linux \
    android-tools-adb \
 && ln -snf /usr/share/zoneinfo/$TZ /etc/localtime \
 && echo $TZ > /etc/timezone \
 && apt-get clean && rm -rf /var/lib/apt/lists/* \
 && mkdir -p /app/logs && chown -R 65534:65534 /app

COPY --from=builder /app/bin/server /app/server
COPY --from=builder /app/configs /app/configs

EXPOSE 50055

# æ³¨æ„ï¼šç«¯å£æ˜ å°„åŠŸèƒ½ä½¿ç”¨nftablesï¼Œéœ€è¦rootæƒé™å’Œå®¿ä¸»æœºPIDå‘½åç©ºé—´
# Dockerè¿è¡Œæ—¶éœ€è¦: --pid=host --privileged
# USER 65534:65534  # ç«¯å£æ˜ å°„åŠŸèƒ½éœ€è¦rootæƒé™ï¼Œå› æ­¤æ³¨é‡Šæ‰æ­¤è¡Œ

ENTRYPOINT ["sh", "-c", "/app/server -config ${RUNTIME_CONFIG_PATH:-/app/configs/online-hk.yaml}"]

